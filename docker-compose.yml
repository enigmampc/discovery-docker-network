version: '3'

services:

  contract:
    build:
      context: enigma-contract
      args:
        - GIT_BRANCH_CONTRACT=${GIT_BRANCH_CONTRACT}
    stdin_open: true
    tty: true
    ports:
        - "9545:9545"
    networks:
        - net
    hostname: enigma_contract
    entrypoint:
        - /bin/bash
        - -c
        - ./start_ganache.bash; bash 
    volumes:
        - "built_contracts:/root/enigma-contract/build/contracts"

  p2p-proxy:
    build: 
      context: enigma-p2p
      args:
        - GIT_BRANCH_P2P=${GIT_BRANCH_P2P}
    stdin_open: true
    tty: true
    ports:
        - "3346:3346"
        - "10300:10300"
    networks:
        - net
    hostname: enigma_p2p_proxy
    entrypoint:
        - /bin/bash
        - -c
        - cd enigma-p2p/src/cli && node cli_app.js -i B1 -b B1 -p B1 --proxy 3346; bash

  p2p-worker:
    build: 
      context: enigma-p2p
      args:
        - GIT_BRANCH_P2P=${GIT_BRANCH_P2P}
    stdin_open: true
    tty: true
    ports:
        - "8081:8081"
    networks:
        - net
    hostname: enigma_p2p_worker
    entrypoint:
        - /bin/bash
        - -c
        - ./start_worker.bash; bash
    volumes:
        - "built_contracts:/root/enigma-p2p/test/ethereum/scripts/build/contracts"

  client:
    build:
      context: enigma-contract
      args:
        - GIT_BRANCH_CONTRACT=${GIT_BRANCH_CONTRACT}
    stdin_open: true
    tty: true
    networks:
        - net
    hostname: client
    volumes:
        - "built_contracts:/root/enigma-contract/build/contracts"

  core:
    build:
      context: enigma-core
      args:
        - SGX_MODE=${SGX_MODE}
        - GIT_BRANCH_CORE=${GIT_BRANCH_CORE}
    stdin_open: true
    tty: true
    ports:
      - "5552-5562:5552"
    devices:
      - "/dev/isgx:/dev/isgx"
    hostname: enigma_core
    networks:
      - net

  principal:
    build:
      context: enigma-core
      dockerfile: Dockerfile.principal
      args:
        - SGX_MODE=${SGX_MODE}
        - GIT_BRANCH_PRINCIPAL=${GIT_BRANCH_PRINCIPAL}
    stdin_open: true
    tty: true
    ports:
      - "5552-5562:5552"
    devices:
      - "/dev/isgx:/dev/isgx"
    hostname: enigma_principal
    networks:
      - net

networks:
    net:

volumes:
  built_contracts:
